<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Assignment 4 â€“ Lead Time & Bullwhip Analysis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #e9f2fb;
      padding: 20px;
    }
    .container {
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }
    h1 {
      color: #007bff;
      background: linear-gradient(90deg, #007bff 0%, #00c6ff 100%);
      -webkit-text-fill-color: transparent;
      -webkit-background-clip: text;
      margin-bottom: 20px;
    }
    .btn-primary {
      background: #0069d9;
      border: none;
      transition: background 0.3s;
    }
    .btn-primary:hover {
      background: #0056b3;
    }
    .result-card {
      margin-top: 30px;
      padding: 20px;
      border-radius: 10px;
      background: #f7faff;
      box-shadow: inset 0 0 10px rgba(0,123,255,0.05);
    }
    .result-card h2 {
      color: #0056b3;
      margin-bottom: 15px;
    }
    .chart-container {
      margin-top: 30px;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-center">Assignment 4: Lead Time & Bullwhip Analysis</h1>
    <p class="lead text-center">Upload your procurement dataset (.xlsx, CSV, etc.) to analyze lead and delay times.</p>

    <div class="d-flex flex-wrap gap-2 justify-content-center mb-4">
      <input type="file" id="xlsxFile" accept=".xlsx,.xls,.csv" class="form-control w-auto" />
      <button class="btn btn-primary" onclick="analyze()">
        Analyze
      </button>
    </div>

    <div id="results"></div>
    <div class="chart-container">
      <canvas id="delayChart" height="80"></canvas>
    </div>
  </div>

  <script>
    function analyze() {
      const file = document.getElementById('xlsxFile').files[0];
      if (!file) return alert("Please upload a file!");

      const reader = new FileReader();
      reader.onload = (e) => {
        let data, workbook;
        try {
          if (file.name.endsWith('.csv')) {
            data = e.target.result;
            const arr = data.split("\n").map(r => r.split(","));
            workbook = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(arr);
            XLSX.utils.book_append_sheet(workbook, ws, "Sheet1");
          } else {
            workbook = XLSX.read(e.target.result, { type: 'binary' });
          }
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });
          calculateResults(rows);
        } catch (err) {
          alert("Error parsing file. Make sure it's a valid XLSX, XLS, or CSV.");
          console.error(err);
        }
      };
      reader.readAsBinaryString(file);
    }

    function parseExcelDate(val) {
      if (typeof val === 'number') {
        const date = XLSX.SSF.parse_date_code(val);
        return date ? new Date(date.y, date.m - 1, date.d) : NaN;
      }
      const d = new Date(val);
      return isNaN(d) ? NaN : d;
    }

    function calculateDays(d1Raw, d2Raw) {
      const d1 = parseExcelDate(d1Raw);
      const d2 = parseExcelDate(d2Raw);
      return (!isNaN(d1) && !isNaN(d2))
        ? (d2 - d1) / (1000 * 60 * 60 * 24)
        : NaN;
    }

    function average(arr) {
      return arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : NaN;
    }

    function groupBy(rows, keyFn, valFn) {
      const map = {};
      rows.forEach(r => {
        const key = typeof keyFn === 'function' ? keyFn(r) : r[keyFn];
        const v = valFn(r);
        if (key && !isNaN(v)) {
          map[key] = map[key] || [];
          map[key].push(v);
        }
      });
      return map;
    }

    function calculateResults(data) {
      if (data.length === 0) {
        alert("No data found.");
        return;
      }
      const bySupplier = groupBy(data, "Supplier", r => calculateDays(r["Order_Date"], r["Actual_Delivery_Date"]));
      const byTransport = groupBy(data, "Transportation_Mode", r => calculateDays(r["Order_Date"], r["Actual_Delivery_Date"]));
      const byMonth = groupBy(data, r => {
        const d = parseExcelDate(r["Expected_Delivery_Date"]);
        return isNaN(d) ? null : d.toLocaleString('default', { month: 'short' });
      }, r => calculateDays(r["Expected_Delivery_Date"], r["Actual_Delivery_Date"]));
      const byDisruption = groupBy(data, "Disruption_Type", r => calculateDays(r["Expected_Delivery_Date"], r["Actual_Delivery_Date"]));
      const byCategory = groupBy(data, "Product_Category", r => calculateDays(r["Order_Date"], r["Actual_Delivery_Date"]));

      const topSupplier = Object.entries(bySupplier).sort((a, b) => average(b[1]) - average(a[1]))[0] || ["N/A", []];
      const bestTransport = Object.entries(byTransport).sort((a, b) => average(a[1]) - average(b[1]))[0] || ["N/A", []];
      const worstMonth = Object.entries(byMonth).sort((a, b) => average(b[1]) - average(a[1]))[0] || ["N/A", []];
      const worstDisrupt = Object.entries(byDisruption).filter(e => e[0] && e[0] !== "None").sort((a, b) => average(b[1]) - average(a[1]))[0] || ["N/A", []];
      const bestCategory = Object.entries(byCategory).sort((a, b) => average(a[1]) - average(b[1]))[0] || ["N/A", []];

      document.getElementById('results').innerHTML = `
        <div class="result-card">
          <h2>ðŸ“Š Analysis Results</h2>
          <p><strong>Supplier w/ Highest Avg Lead Time:</strong> ${topSupplier[0]} â€” ${average(topSupplier[1]).toFixed(2)} days</p>
          <p><strong>Fastest Transport Mode:</strong> ${bestTransport[0]} â€” ${average(bestTransport[1]).toFixed(2)} days</p>
          <p><strong>Month w/ Highest Avg Delay:</strong> ${worstMonth[0]} â€” ${average(worstMonth[1]).toFixed(2)} days</p>
          <p><strong>Worst Disruption Type:</strong> ${worstDisrupt[0]} â€” ${average(worstDisrupt[1]).toFixed(2)} days</p>
          <p><strong>Best Product Category:</strong> ${bestCategory[0]} â€” ${average(bestCategory[1]).toFixed(2)} days</p>
        </div>`;
      renderChart(byMonth);
    }

    function renderChart(grouped) {
      const ctx = document.getElementById('delayChart').getContext('2d');
      const labels = Object.keys(grouped);
      const values = labels.map(l => average(grouped[l]).toFixed(2));
      new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Avg Delay by Month (days)', data: values, backgroundColor: 'rgba(0,123,255,0.6)' }] },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });
    }
  </script>
</body>
</html>
